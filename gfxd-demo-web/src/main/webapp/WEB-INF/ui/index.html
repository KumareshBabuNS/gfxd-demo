<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">
<head>
    <title>GFXD Demo</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <script src="lib/d3.v3.js"></script>
    <script src="lib/rickshaw.js"></script>
    <script src="lib/knockout-3.0.0.js"></script>
    <script src="js/gfxd-demo.js"></script>
    <link href="css/style.css" rel="stylesheet" type="text/css"/>
    <link href="css/bootstrap.css" rel="stylesheet" type="text/css"/>
    <link href="css/rickshaw.css" rel="stylesheet" type="text/css"/>
</head>
<body ng-app="main">
<div class="container-fluid">
    <div class="row-fluid">
        <div class="span8 offset2">
            <h1 class="well">
                <!--
                <a href="default.htm">
                    <img src="img/logo.png" height="60" width="60" alt="logo"/>
                </a>
                -->
                GemfireXD Smart Grid Demo
            </h1>
        </div>
    </div>
</div>
<br/>
<br/>
<br/>

<div class="container-fluid">
    <div class="row-fluid">
        <div class="span8 offset2">
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span9">
                        <div class="row-fluid">
                            <div class="span8">
                                <!--<p>Event Rate: <span data-bind="text: eventRate"></span></p>-->
                                <div id="event_rate_chart"></div>
                            </div>
                            <div class="span4">
                                <p>Event Rate: <span data-bind="text: eventRate"></span></p>
                                <label class="radio">
                                    <input type="radio" name="liveRandomRadio" value="live" data-bind="checked: liveRandom" />
                                    Live data
                                </label>
                                <label class="radio">
                                    <input type="radio" name="liveRandomRadio" value="random" data-bind="checked: liveRandom" />
                                    Random data
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="span3 well">
                        <button class="btn-small btn-info" data-bind="click: runMapReduce">Run MapReduce</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<br/>
<br/>
<!--<script src="js/gfxd-demo.js" type="text/javascript"/>-->
<script>
    var tv = 1000;

    var eventRateUrl = "/data/random";

    var throughput = new Rickshaw.Graph({
        element: document.querySelector("#event_rate_chart"),
        width: "400",
        height: "200",
        renderer: "line",
        series: new Rickshaw.Series.FixedDuration([
            {
                name: 'one',
                color: 'gold'
            }
        ], undefined, {
            timeInterval: tv,
            maxDataPoints: 100,
            timeBase: new Date().getTime() / 1000
        })
    });
    var axes = new Rickshaw.Graph.Axis.Time({
        graph: throughput
    });
    axes.render();

    var yAxis = new Rickshaw.Graph.Axis.Y({
        graph: throughput,
    });
    yAxis.render();

    throughput.render();

    setInterval(function () {
        pollServer(throughput);
    }, tv);

    function pollServer(chart) {
        // Change this to "/data/events-loaded for real data
        d3.json(eventRateUrl, function (error, json) {
            if (error) {
                console.log(error);
            } else {
                var data = {one: json.value};
                chart.series.addData(data);
                chart.render();
                yAxis.render();
                chartModel.eventRate(Math.round(json.value));
            }
        })
    }

    function ChartViewModel() {
        this.eventRate = ko.observable(0);
        this.liveRandom = ko.observable("random");

        this.liveRandom.subscribe(function(arg) {
            if (arg == "live") {
                eventRateUrl = "/data/events-loaded";
            } else {
                eventRateUrl = "/data/random";
            }
        });

        this.runMapReduce = function() {
            console.log("--->>> Running MapReduce");
//            d3.json("/data/run-mapreduce", function (error, json) {
//                if (error) {
//                    console.log(error);
//                } else {
//                    console.log(json);
//                }
//            });
        }
    }

    var chartModel = new ChartViewModel();

    // Activates knockout.js
    ko.applyBindings(chartModel);
</script>
</body>
</html>